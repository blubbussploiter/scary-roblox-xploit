#pragma once

#include "util/static_addresses.h"
#include "dynamic_addresses.h"
#include "execution.h"

std::string ezRead(std::string f)
{
	std::ifstream t(f);
	if (t.good())
	{
		return std::string((std::istreambuf_iterator<char>(t)),
			std::istreambuf_iterator<char>());
	}
	return "";
}

int loadstring(uintptr_t L)
{
	//std::string script = RBX::FamilyGuy::lua::tolstring(L, 1);
	std::string script = "printidentity()";

	if (!script.empty())
	{
		std::string bytecode = RBX::Execution::get()->doSerialize(L, script, "=");
		if (RBX::FamilyGuy::feedDeserializer(L, bytecode, "=", 1) == 0)
		{
			return 1;
		}
	}

	RBX::FamilyGuy::lua::pushnil(L);
	RBX::FamilyGuy::lua::insert(L, -2);
	return 2;
}

int loadfile(uintptr_t L)
{
	std::string script = RBX::FamilyGuy::lua::tolstring(L, 1);

	if (!script.empty())
	{
		std::string read = ezRead(script);
		if (!read.empty())
		{
			std::string bytecode = RBX::Execution::get()->doSerialize(L, script, "file");
			return RBX::FamilyGuy::feedDeserializer(L, bytecode, "file", 1);
		}
	}

	return 0;
}

static void pushAll()
{

	uintptr_t luaState = RBX::FamilyGuy::getLuaState();

	RBX::FamilyGuy::lua::pushcclosure(luaState, (int)loadstring, 0);
	RBX::FamilyGuy::lua::setfield(luaState, LUA_GLOBALSINDEX, "loadstring");

	RBX::FamilyGuy::lua::pushcclosure(luaState, (int)loadfile, 0);
	RBX::FamilyGuy::lua::setfield(luaState, LUA_GLOBALSINDEX, "loadfile");

}